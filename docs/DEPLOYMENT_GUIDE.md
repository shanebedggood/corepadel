# Deployment Guide - Core Padel

This guide will help you deploy the Core Padel application to Firebase and Google Cloud Platform using GitHub Actions.

## Architecture Overview

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Angular App   │    │   Quarkus API   │    │  PostgreSQL DB  │
│  (Firebase      │◄──►│   (Cloud Run)   │◄──►│   (Cloud SQL)   │
│   Hosting)      │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  Firebase Auth  │    │  Firebase       │    │  Cloud Storage  │
│                 │    │  Storage        │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## Prerequisites

1. **Google Cloud Project**: Create a project with ID `corepadelapp`
2. **Firebase Project**: Set up Firebase in the same project
3. **GitHub Repository**: Your code should be in a GitHub repository
4. **Google Cloud CLI**: Install and authenticate with `gcloud auth login`

## Step 1: Initial GCP Setup

Run the setup script to create all required GCP resources:

```bash
chmod +x setup-gcp.sh
./setup-gcp.sh
```

This script will:
- Enable required APIs
- Create Cloud SQL PostgreSQL instance
- Create service accounts with proper permissions
- Generate database credentials

## Step 2: Configure GitHub Secrets

Add the following secrets to your GitHub repository (Settings → Secrets and variables → Actions):

### Required Secrets:

1. **GCP_SA_KEY**
   - Content of the `cloudbuild-deployer-key.json` file generated by the setup script
   - Used for Cloud Run deployment

2. **DATABASE_URL**
   - JDBC URL for Cloud SQL connection
   - Format: `jdbc:postgresql:///corepadel?cloudSqlInstance=corepadelapp:us-central1:corepadel-db&socketFactory=com.google.cloud.sql.postgres.SocketFactory`

3. **DATABASE_USERNAME**
   - Database username (usually `corepadel`)

4. **DATABASE_PASSWORD**
   - Database password generated by the setup script

5. **FIREBASE_SERVICE_ACCOUNT**
   - Firebase service account JSON (download from Firebase Console)
   - Go to Project Settings → Service Accounts → Generate new private key

6. **FIREBASE_TOKEN**
   - Firebase CI token for automated deployments
   - Generate with: `firebase login:ci`

### Optional Secrets:

7. **MIGRATION_TOKEN**
   - Token for database migration endpoint (if implemented)

## Step 3: Database Setup

Connect to your Cloud SQL instance and run the database migrations:

```bash
# Connect to the database
gcloud sql connect corepadel-db --user=corepadel --database=corepadel

# Run the DDL script
\i database/corepadel.ddl

# Run DML scripts
\i database/dml/club.sql
\i database/dml/role.sql
\i database/dml/rule.sql
\i database/dml/tournament_config.sql
\i database/dml/venue.sql
```

## Step 4: Deploy Application

### Automatic Deployment (Recommended)

Push to the `main` branch to trigger automatic deployment:

```bash
git add .
git commit -m "Ready for production deployment"
git push origin main
```

The GitHub Actions workflow will:
1. Build and deploy Angular app to Firebase Hosting
2. Build and deploy Quarkus app to Cloud Run
3. Deploy Firebase services (Auth, Storage)
4. Update frontend configuration with backend URL

### Manual Deployment

If you prefer manual deployment:

```bash
# Deploy using Cloud Build
gcloud builds submit --config cloudbuild.yaml

# Or deploy Firebase services manually
firebase deploy --only auth,storage,hosting
```

## Step 5: Verify Deployment

### Check Services:

1. **Frontend**: https://corepadelapp.web.app
2. **Backend**: Check Cloud Run console for the service URL
3. **Database**: Verify connection in Cloud SQL console

### Test Endpoints:

```bash
# Health check
curl https://your-cloud-run-url/health

# API endpoints
curl https://your-cloud-run-url/api/players
```

## Step 6: Environment Configuration

### Update Angular Environment

The deployment will automatically update your Angular environment with the correct backend URL. If you need to update manually:

```typescript
// web/web-app/src/environments/environment.prod.ts
export const environment = {
  production: true,
  backendUrl: 'https://your-cloud-run-url',
  firebase: {
    projectId: 'corepadelapp',
    // ... other Firebase config
  }
};
```

### Update Quarkus Configuration

The production configuration is in `services/src/main/resources/application-prod.properties` and will be used automatically in Cloud Run.

## Monitoring and Maintenance

### Cloud Run Monitoring:

- **Logs**: View in Cloud Run console or with `gcloud logs read`
- **Metrics**: Available in Cloud Monitoring
- **Health Checks**: Configured at `/health/live` and `/health/ready`

### Database Monitoring:

- **Cloud SQL**: Monitor in Cloud SQL console
- **Backups**: Automatic daily backups configured
- **Maintenance**: Scheduled for Sundays at 3 AM

### Firebase Monitoring:

- **Analytics**: Available in Firebase console
- **Crashlytics**: Set up for error tracking
- **Performance**: Monitor app performance

## Troubleshooting

### Common Issues:

1. **Build Failures**:
   - Check GitHub Actions logs
   - Verify all secrets are configured correctly
   - Ensure all dependencies are in package.json

2. **Database Connection Issues**:
   - Verify Cloud SQL instance is running
   - Check connection string format
   - Ensure service account has proper permissions

3. **CORS Issues**:
   - Verify CORS configuration in Quarkus
   - Check allowed origins include your Firebase hosting URL

4. **Authentication Issues**:
   - Verify Firebase service account configuration
   - Check Firebase project ID matches

### Useful Commands:

```bash
# Check Cloud Run service status
gcloud run services describe corepadel-quarkus --region=us-central1

# View logs
gcloud logs read "resource.type=cloud_run_revision"

# Connect to database
gcloud sql connect corepadel-db --user=corepadel --database=corepadel

# Update service with new environment variables
gcloud run services update corepadel-quarkus \
  --set-env-vars="NEW_VAR=value" \
  --region=us-central1
```

## Cost Optimization

### Estimated Monthly Costs (us-central1):

- **Cloud SQL (db-f1-micro)**: ~$7.50/month
- **Cloud Run**: ~$5-15/month (depending on usage)
- **Firebase Hosting**: Free tier
- **Firebase Auth**: Free tier
- **Firebase Storage**: Free tier (1GB)
- **Container Registry**: ~$1-2/month

### Optimization Tips:

1. **Cloud SQL**: Use db-f1-micro for development, upgrade as needed
2. **Cloud Run**: Set max instances to limit costs
3. **Container Registry**: Clean up old images regularly
4. **Monitoring**: Set up billing alerts

## Security Considerations

1. **Database**: Use Cloud SQL with private IP when possible
2. **Secrets**: Store all sensitive data in GitHub secrets
3. **Firewall**: Configure Cloud SQL firewall rules
4. **IAM**: Use least privilege principle for service accounts
5. **HTTPS**: All services use HTTPS by default

## Next Steps

1. Set up monitoring and alerting
2. Configure custom domain (optional)
3. Set up CI/CD for different environments (staging, production)
4. Implement database migration automation
5. Add performance monitoring and optimization
