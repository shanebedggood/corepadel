<div class="card">
    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>

    <!-- Header -->
    <div class="mb-6">
        <div class="text-2xl font-bold text-gray-900 mb-2">{{ isEditing ? 'Edit Team' : 'Add Team' }}</div>
        @if (group) {
            <p class="text-gray-600">
                {{ isEditing ? 'Editing team in' : 'Adding team to' }} {{ group.name }}
            </p>
        }
    </div>

    <!-- Team Form -->
    <div class="mb-6">
        <div class="text-lg font-semibold mb-4">Team Details</div>
        <form [formGroup]="teamForm" class="space-y-4">
            <div class="field">
                <label for="addTeamName" class="block mb-2 font-medium">Team Name</label>
                <div class="flex gap-2">
                    <input pInputText id="addTeamName" [value]="teamName" (input)="onTeamNameInput($event)"
                        class="flex-1" placeholder="Enter team name" [attr.data-team-name]="teamName" />
                </div>
            </div>
        </form>
    </div>

    <!-- Player Selection -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Search Section -->
        <div>
            <div class="text-lg font-semibold mb-4">Search Players</div>

            <!-- Search Input -->
            <div class="mb-4">
                <p-inputgroup>
                    <input pInputText type="text" placeholder="Search by name, email, or user ID (min 3 chars)"
                        [(ngModel)]="searchTerm" (keyup.enter)="onSearchKeydown($event)" #searchInput />
                    <button pButton type="button" icon="pi pi-search" [disabled]="!canSearch() || searchLoading"
                        [loading]="searchLoading" (click)="searchPlayers()" pTooltip="Search Players">
                    </button>
                    <button pButton type="button" icon="pi pi-times" [disabled]="!searchTerm.trim()"
                        (click)="clearSearch()" pTooltip="Clear Search">
                    </button>
                </p-inputgroup>
                <small class="text-gray-500">Enter at least 3 characters or a valid user ID to search</small>
            </div>

            <!-- Search Results -->
            <div class="space-y-2 max-h-96 overflow-y-auto">
                @if (hasSearched && searchResults.length === 0) {
                    <p-message severity="info"
                        [text]="'No players found matching your search' + (selectedPlayers.length > 0 ? '. Note: Already selected players are hidden from search results.' : '')"
                        styleClass="w-full">
                    </p-message>
                }

                @for (player of searchResults; track player.firebaseUid) {
                    <div class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 cursor-pointer"
                        (click)="selectPlayer(player)">
                        <div class="flex-1">
                            <div class="font-medium">{{ player.display_name }}</div>
                            <div class="text-sm text-gray-600">{{ player.email }}</div>
                        </div>
                        <button pButton type="button" icon="pi pi-plus" class="p-button-sm p-button-success p-button-text"
                            pTooltip="Add Player">
                        </button>
                    </div>
                }
            </div>
        </div>

        <!-- Selected Players -->
        <div>
            <div class="text-lg font-semibold mb-4">Selected Players</div>
            <div class="border rounded-lg p-4 shadow-sm bg-white" [ngClass]="{ 
          'border-green-300 bg-green-50': selectedPlayers.length >= 1, 
          'border-gray-300 bg-gray-50': selectedPlayers.length === 0 
        }">

                <!-- Header with count -->
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <div class="flex items-center justify-center w-8 h-8 rounded-full text-sm font-semibold"
                            [ngClass]="{ 
                'bg-green-100 text-green-700': selectedPlayers.length >= 1, 
                'bg-gray-100 text-gray-500': selectedPlayers.length === 0 
              }">
                            {{ selectedPlayers.length }}
                        </div>
                        <span class="text-sm font-medium text-gray-600">Players Selected</span>
                    </div>

                    <!-- Status indicator -->
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full" [ngClass]="{ 
                'bg-green-500': selectedPlayers.length >= 1, 
                'bg-gray-400': selectedPlayers.length === 0 
              }">
                        </div>
                        <span class="text-xs font-medium" [ngClass]="{ 
                'text-green-700': selectedPlayers.length >= 1, 
                'text-gray-500': selectedPlayers.length === 0 
              }">
                            {{ selectedPlayers.length >= 1 ? 'Ready' : 'Empty' }}
                        </span>
                    </div>
                </div>

                <!-- Empty state -->
                @if (selectedPlayers.length === 0) {
                    <div class="text-center py-8">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                        <i class="pi pi-users text-2xl text-gray-400"></i>
                    </div>
                    <p class="text-gray-600 mb-2">No players selected yet</p>
                    <p class="text-sm text-gray-500">Search and select players to form a team</p>
                    </div>
                }

                <!-- Selected players list -->
                @if (selectedPlayers.length > 0) {
                    <div class="space-y-3">
                    @for (player of selectedPlayers; track player.firebaseUid; let i = $index) {
                        <div class="flex items-center justify-between p-3 bg-white border rounded-lg shadow-sm border-green-200">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-sm font-semibold text-gray-600">
                                    {{ i + 1 }}
                                </div>
                                <div>
                                    <div class="font-medium text-gray-900">{{ player.display_name }}</div>
                                    <div class="text-sm text-gray-500">{{ player.email }}</div>
                                </div>
                            </div>
                            <button pButton type="button" icon="pi pi-times"
                                class="p-button-sm p-button-outlined p-button-danger" (click)="removePlayer(player)"
                                pTooltip="Remove Player">
                            </button>
                        </div>
                    }
                    </div>
                }

                <!-- Status message -->
                @if (selectedPlayers.length > 0) {
                    <div class="mt-4 p-3 rounded-lg bg-green-100 border border-green-200">
                    <div class="flex items-center gap-2">
                        <i class="pi pi-check-circle text-green-600"></i>
                        <span class="text-sm font-medium text-green-700">
                            Team is ready to save!
                        </span>
                    </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Form Actions -->
    <div class="flex flex-col pt-6 justify-end gap-2">
        <div class="flex gap-2 justify-end">
            <p-button label="Cancel" icon="pi pi-times" severity="secondary" (onClick)="cancel()" />
            <p-button label="{{ isEditing ? 'Update Team' : 'Save Team' }}" icon="pi pi-check" [loading]="loading"
                [disabled]="!canSave()" (onClick)="saveTeam()" />
        </div>
    </div>
</div>